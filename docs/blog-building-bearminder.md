# Building BearMinder: a tiny macOS menubar app that logs Bear words to Beeminder

This is a short dev journal about how the first working version of BearMinder came together, the roadblocks we hit, and what we learned along the way.

## Why a menubar app?
We wanted something that:
- Stays out of your way while you write in Bear.
- Posts just today‚Äôs words to a Beeminder goal.
- Runs on demand (hourly background sync later), handles auth securely, and is easy to tweak.

The result: a tiny AppKit app with a üêª in the menu bar and a single Settings window for tokens and goal name.

## Architecture at a glance
- App target lives in `Apps/BearMinder/` (generated by XcodeGen).
- App layer code lives in `AppTemplate/`:
  - `AppDelegate.swift` wires everything, calculates today‚Äôs delta, and posts.
  - `StatusItemController.swift` shows the üêª menu and actions.
  - `SettingsWindowController.swift` stores tokens in Keychain.
  - `AppDelegate+URLHandling.swift` registers and handles `bearminder://‚Ä¶` callbacks.
- Core code is a Swift Package in `Sources/` (`Models`, `KeychainSupport`, `BeeminderClient`, etc.).

## Early roadblocks (and how we fixed them)

### 1) Menubar UI not showing, lifecycle ambiguity
- Symptom: build succeeded but the app didn‚Äôt show a menubar item and `_main` linker errors appeared at times.
- Fixes:
  - Added an explicit AppKit entry point in `AppTemplate/Main.swift` with `@main` and `NSApplication.shared.run()`.
  - Ensured the Xcode project includes new sources by regenerating with XcodeGen (`Apps/BearMinder/project.yml`).
  - Verified target contains `AppTemplate/Main.swift` and `AppTemplate/AppDelegate.swift`.
  - Temporarily set `LSUIElement=false` in `Apps/BearMinder/Info.plist` to surface a Dock icon during debugging.

### 2) No callbacks from Bear
- Symptom: clicking ‚ÄúSync Now‚Äù produced no runtime logs, only build logs.
- Fix:
  - Registered the URL event handler in `AppDelegate+URLHandling.swift` with `NSAppleEventManager` for `kAEGetURL`.
  - Created `BearCallbackCoordinator` to parse and broadcast callback payloads.
  - Added structured logs to confirm: registered handler ‚Üí received URL ‚Üí parsed params.

### 3) Bear‚Äôs callback shape differs between actions
- Symptom: `bear://x-callback-url/search` returned a `notes` param (JSON array), not a simple `ids` list.
- Fix:
  - `AppTemplate/BearIntegrationManager.swift` now decodes the JSON `notes` value when present and extracts identifiers, titles, tags, and timestamps.
  - Filters notes to those modified ‚Äútoday‚Äù (UTC) via `modificationDate`.
  - Per note, calls `open-note` and reads the body from `text` or `note` (Bear versions differ here).

### 4) Newlines didn‚Äôt render in Beeminder comments
- Symptom: comments displayed literal `\n` on Beeminder.
- Fix:
  - Rebuilt the `application/x-www-form-urlencoded` body using `URLComponents.percentEncodedQuery` in `Sources/BeeminderClient/BeeminderClient.swift`.
  - The two-line comment now renders correctly in the datapoint detail view.

### 5) Daily totals vs deltas: what‚Äôs the right baseline?
- Goal: Post only **today‚Äôs** new words.
- Challenges we ran into:
  - A first attempt used a moving baseline within the day, which could zero out later syncs.
  - For brand new notes created today, a bad baseline sometimes initialized to the current count, yielding delta 0.
- Fix:
  - In `AppTemplate/AppDelegate.performRealSyncNow()` we compute today‚Äôs delta against **yesterday‚Äôs end-of-day** count for each note (UTC). If none exists, baseline = 0.
  - We added a corrector: if a today record exists where `previousWordCount == currentWordCount` and there‚Äôs no yesterday record, we treat baseline as 0 for the computation and rewrite today‚Äôs tracking entry accordingly.
  - We skip posting when the daily delta is 0 to avoid overwriting a positive datapoint with zero.

### 6) Persistent Keychain prompts
- Symptom: macOS asked for Keychain access on every launch.
- Fix:
  - When writing tokens, we now set `kSecAttrAccessibleAfterFirstUnlock` in `Sources/KeychainSupport/KeychainSupport.swift`.
  - Users can also open Keychain Access ‚Üí find items with Service `bear`/`beeminder` (Account `token`) ‚Üí Access Control ‚Üí add BearMinder and ‚ÄúAlways Allow‚Äù.

## The working flow today
1. Click üêª ‚Üí **Sync Now**.
2. `BearIntegrationManager` searches broadly and receives a JSON `notes` array.
3. It filters to notes modified today (UTC), then fetches each note‚Äôs body.
4. `AppDelegate.performRealSyncNow()` computes today‚Äôs delta as `sum(max(0, current - yesterday_baseline))`.
5. The app posts only today‚Äôs delta to Beeminder with a concise two‚Äëline comment and a date‚Äëbased `requestid`.

## Insights and takeaways
- **Make the entry point explicit.** Menubar apps avoid some lifecycle niceties; an explicit `@main` + `NSApplication.shared.run()` removes ambiguity.
- **Regenerate your Xcode project** when you add sources under XcodeGen. Otherwise you‚Äôll chase phantom linker/visibility issues.
- **Log runtime, not just builds.** Xcode can hide important runtime logs unless you focus the run console.
- **APIs drift.** The Bear URL API returns different param shapes between actions and versions; code to the observed payload and keep fallbacks.
- **UTC everywhere.** Day boundaries and cross-timezone behavior are safer and more predictable with UTC.
- **Be conservative with posting.** Skip posting 0s to avoid clobbering good data.

## What‚Äôs next
- **Hourly background sync** with a last-sync indicator in the menu.
- **Start at Login** via `SMAppService` + a toggle in Settings.
- **Tag filters** (UI + logic) to include only certain notes.
- **Gentle notifications** for persistent auth/network errors.
- **Offline queue** for datapoints when the network or Beeminder is down.
- **Polish**: remove the launch alert and reduce logs for production.

If you want to tinker, see the Developer Guide in `README.md` and the TODO in `TODO.md`.
